<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
  </head>
  <body>
    <script>
        // Scale all font sizes by 1.5x if screen width is greater than 1920px (HD)
        if (window.screen && window.screen.width > 1920) {
          document.documentElement.style.setProperty('--font-scale', '1.5');
        } else {
          document.documentElement.style.setProperty('--font-scale', '1');
        }
    </script>
    <div class="main-grid-container">
      <!-- Row 1: Ticker tape in its own container -->
      <div class="grid-row-1">
        <div class="grid-ticker">
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Ticker tape by TradingView</span></a></div>
            <script type="text/javascript">
              window.tvTickerTapeWidgetOptions = {
                symbols: [
                  { proName: "CMCMARKETS:EURUSD", title: "EUR USD" },
                  { proName: "CMCMARKETS:EURGBP", title: "EUR GBP" },
                  { proName: "GOMARKETS:DAX40", title: "DAX40" },
                  { proName: "GOMARKETS:FTSE100", title: "FTSE100" },
                  { proName: "XETR:UN0", title: "UNIPER" }
                ],
                colorTheme: "light",
                locale: "en",
                largeChartUrl: "",
                isTransparent: false,
                showSymbolLogo: true,
                displayMode: "compact"
              };
            </script>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async></script>
          </div>
        </div>
      </div>
      <!-- Main grid row: 2 iframes and XBRUSD widget -->
      <div class="grid-main">
        <div class="grid-col grid-col-1">
          <iframe src="https://haltestellenmonitor.vrr.de/?id=woXOLBBlPWG+hqVedT7+ug==#/monitor" width="100%" height="400" style="border:none;" title="Haltestellenmonitor Widget"></iframe>
        </div>
        <div class="grid-col grid-col-2">
          <iframe src="https://uniper.signage-server.de/uniper-campus-capricorn/web-app/" width="100%" height="400" style="border:none;" title="Uniper Campus Capricorn Widget"></iframe>
        </div>
        <div class="grid-col grid-col-3">
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/ICMARKETS-XBRUSD/?exchange=ICMARKETS" rel="noopener nofollow" target="_blank"><span class="blue-text">XBRUSD chart by TradingView</span></a></div>
            <script type="text/javascript">
              window.tvMiniSymbolWidgetOptions = {
                symbol: "ICMARKETS:XBRUSD",
                chartOnly: false,
                dateRange: "12M",
                noTimeScale: false,
                colorTheme: "light",
                isTransparent: false,
                locale: "en",
                largeChartUrl: "https://www.tradingview.com/chart/?symbol=FUSIONMARKETS%3AXBRUSD",
                width: "100%",
                autosize: true,
                height: "400"
              };
            </script>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async></script>
          </div>
          <!-- Energy price line plot -->
          <div style="margin-top:24px; width:100%;">
            <canvas id="energyPriceChart" style="width:100%;max-width:100%;height:400px;"></canvas>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
            // Fetch and plot energy price data for DE-LU from yesterday to tomorrow
            function getDateString(offsetDays) {
              const d = new Date();
              d.setDate(d.getDate() + offsetDays);
              return d.toISOString().slice(0, 10);
            }
            const start = getDateString(-1); // yesterday
            const end = getDateString(1);   // tomorrow
            const apiUrl = `https://proxy.corsfix.com/?url=https://api.energy-charts.info/price?bzn=DE-LU&start=${start}&end=${end}`;
            fetch(apiUrl, {
              headers: { 'accept': 'application/json' }
            })
              .then(response => response.json())
              .then(data => {
                // Defensive: check structure
                if (!data || !Array.isArray(data.unix_seconds) || !Array.isArray(data.price)) {
                  throw new Error('Unexpected data format');
                }
                // Convert unix_seconds to local time strings
                const labels = data.unix_seconds.map(ts => {
                  const d = new Date(ts * 1000);
                  return d.toLocaleString('de-DE', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                });
                const ctx = document.getElementById('energyPriceChart').getContext('2d');
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [{
                      label: data.unit || 'EUR / MWh',
                      data: data.price,
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.2)',
                      fill: false,
                      tension: 0.2
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      title: {
                        display: true,
                        text: 'Day-Ahead Power Price (DE-LU)'
                      },
                      legend: {
                        display: true
                      },
                      tooltip: {
                        mode: 'index',
                        intersect: false
                      }
                    },
                    interaction: {
                      mode: 'nearest',
                      axis: 'x',
                      intersect: false
                    },
                    scales: {
                      x: {
                        title: { display: true, text: 'Time' },
                        ticks: { maxRotation: 90, minRotation: 45 }
                      },
                      y: {
                        title: { display: true, text: data.unit || 'EUR / MWh' }
                      }
                    }
                  }
                });
              })
              .catch(error => {
                console.error('Error fetching or plotting energy price data:', error);
                const chartDiv = document.getElementById('energyPriceChart');
                if (chartDiv) {
                  chartDiv.outerHTML = '<div style="color:red;">Fehler beim Laden der Preisdaten.</div>';
                }
              });
          </script>
        </div>
      </div>
    </div>
  </body>
</html>